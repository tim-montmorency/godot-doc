name: "ğŸ® Build Godot Examples Documentation (Universal)"

# Single source of truth for Godot version: build_config.json

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: "Force rebuild all projects"
        required: false
        default: false
        type: boolean

concurrency:
  group: main-build-documentation-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    name: "ğŸ—ï¸ Build & Deploy with Universal Build System"
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    env:
      PYTHON_VERSION: "3.11"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true
          lfs: true

      - name: Run docsh autorun scripts
        # Run autorun from the docsh submodule so any repository-specific
        # prep scripts are executed early (docsh is checked out via submodules).
        run: |
          echo "Running docsh autorun scripts..."
          bash ./docsh/autorun.sh
        shell: bash

      - name: Read Godot version from build_config.json
        id: read_config
        run: |
          echo "Reading Godot version from build_config.json..."
          VERSION=$(python -c "import json,sys; print(json.load(open('build_config.json'))['godot_version'])")
          if [ -z "$VERSION" ]; then echo "Failed to read godot_version"; exit 1; fi
          echo "GODOT_VERSION=$VERSION" >> $GITHUB_ENV
          echo "Using Godot version: $VERSION"

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Setup Godot Environment
        run: |
          echo "ğŸ® Setting up Godot $GODOT_VERSION environment..."
          python godot-ci-build-system/build.py setup \
            --godot-version $GODOT_VERSION \
            --verbose

      - name: Verify Godot Environment
        run: |
          echo "ğŸ” Verifying Godot environment..."
          python godot-ci-build-system/build.py verify \
            --godot-version $GODOT_VERSION \
            --verbose

      - name: Clean previous artifacts
        run: |
          echo "ğŸ§¹ Cleaning previous build artifacts..."
          python godot-ci-build-system/build.py clean \
            --verbose

      - name: Build projects and documentation
        run: |
          echo "ğŸ—ï¸ Building all projects and final documentation with embeds..."
          python godot-ci-build-system/build.py final \
            --godot-version $GODOT_VERSION \
            --jobs 4 \
            --verbose \
            ${{ github.event.inputs.force_rebuild == 'true' && '--force-rebuild' || '' }}

      - name: Prepare deployment artifact
        run: |
          echo "ğŸ“¦ Preparing deployment artifact..."
          python godot-ci-build-system/build.py artifact \
            --artifact-output ./deployment \
            --verbose

      - name: Setup Pages
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: actions/configure-pages@v4

      - name: Upload to GitHub Pages
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./deployment

      - name: Deploy to GitHub Pages
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Build Summary
        if: always()
        run: |
          echo "ğŸ® Universal Build System Summary"
          echo "================================"
          echo ""
          echo "ğŸ¯ Godot Version: $GODOT_VERSION"
          echo "ğŸ”„ Force Rebuild: ${{ github.event.inputs.force_rebuild || 'false' }}"
          echo "ğŸ“Š Build Status: ${{ job.status }}"
          echo ""
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… Build completed successfully using the universal build system!"
            echo "ğŸš€ All CI/CD logic is now encapsulated in the build system."
          else
            echo "âŒ Build failed!"
          fi
